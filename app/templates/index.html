<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SNS Multi-Post</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Post to X, Bluesky, and Misskey simultaneously">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SNS Post">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icon-192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/static/favicon-16x16.png">
    <link rel="shortcut icon" href="/static/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        .mobile-submit-container {
            position: relative;
        }

        @media (max-width: 768px) {
            body {
                padding-bottom: 7rem;
            }

            #postForm {
                padding-bottom: 1rem;
            }

            .mobile-submit-container {
                position: fixed;
                left: 1rem;
                right: 1rem;
                bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
                z-index: 40;
            }

            .mobile-submit-container::before {
                content: "";
                position: absolute;
                inset: -1rem -1rem auto;
                height: 4rem;
                background: linear-gradient(180deg, rgba(245, 247, 250, 0) 0%, rgba(245, 247, 250, 0.9) 80%);
                z-index: -1;
                border-radius: 1rem;
            }
        }

        @media (min-width: 769px) {
            .mobile-submit-container {
                position: static;
                transform: none !important;
            }
        }
    </style>
</head>

<body class="min-h-screen p-4 md:p-8 text-gray-800">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <header class="mb-8 text-center">
            <h1
                class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">
                SNS Multi-Post
            </h1>
            <p class="text-gray-600">Post to X, Bluesky, and Misskey simultaneously</p>
        </header>

        <!-- Notifications -->
        {% if message %}
        <div
            class="mb-6 p-4 rounded-lg bg-green-100 border border-green-400 text-green-700 shadow-sm flex items-center">
            <i class="fas fa-check-circle mr-2"></i> {{ message }}
        </div>
        {% endif %}
        {% if error %}
        <div class="mb-6 p-4 rounded-lg bg-red-100 border border-red-400 text-red-700 shadow-sm flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i> {{ error }}
        </div>
        {% endif %}

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Main: Post Form (now first for mobile) -->
            <div class="md:col-span-2 order-1">
                <div class="glass rounded-xl p-6 shadow-lg h-full">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-pen-fancy mr-2 text-purple-500"></i> New Post
                    </h2>

                    <form action="/post" method="post" enctype="multipart/form-data" id="postForm">
                        <!-- Advanced Settings: Post to / Misskey Visibility -->
                        <details id="advancedSettings"
                            class="mb-4 rounded-lg bg-white/60 border border-gray-200 overflow-hidden">
                            <summary
                                class="list-none cursor-pointer px-3 py-2 flex items-center justify-between text-sm font-medium text-gray-700 select-none">
                                <span class="flex items-center">
                                    <i class="fas fa-sliders-h mr-2 text-purple-500"></i>
                                    投稿先・Misskey設定
                                </span>
                                <span class="text-xs text-gray-500 flex items-center">
                                    タップして表示
                                    <i class="fas fa-chevron-down ml-1 text-gray-400"></i>
                                </span>
                            </summary>
                            <div class="px-3 pb-3 pt-2 space-y-4">
                                <!-- Account Selection -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Post to:</label>
                                    <div class="flex flex-wrap gap-2">
                                        {% for provider, accs in accounts.items() %}
                                        {% for acc in accs %}
                                        <label
                                            class="inline-flex items-center bg-white border border-gray-200 rounded-full px-3 py-1 cursor-pointer hover:bg-gray-50 transition select-none">
                                            <input type="checkbox" name="selected_accounts"
                                                value="{{ provider }}:{{ acc.id }}"
                                                class="form-checkbox h-4 w-4 text-purple-600 rounded border-gray-300 focus:ring-purple-500"
                                                checked onchange="updateCharLimit()">
                                            <span class="ml-2 text-sm text-gray-700">
                                                {% if provider == 'twitter' %}<i
                                                    class="fab fa-twitter text-blue-400 mr-1"></i>{% endif %}
                                                {% if provider == 'bluesky' %}<i
                                                    class="fa-brands fa-bluesky text-blue-600 mr-1"></i>{%
                                                endif %}
                                                {% if provider == 'misskey' %}<i
                                                    class="fas fa-rocket text-green-500 mr-1"></i>{% endif %}
                                                {{ acc.username }}
                                            </span>
                                        </label>
                                        {% endfor %}
                                        {% endfor %}
                                    </div>
                                    <p id="accountError" class="text-red-500 text-xs mt-1 hidden">Please select at least
                                        one
                                        account.</p>
                                </div>

                                <!-- Misskey Visibility -->
                                <div id="misskeyVisibilitySection">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Misskey
                                        Visibility</label>
                                    <select name="misskey_visibility"
                                        class="w-full p-2 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white/80">
                                        <option value="public">Public</option>
                                        <option value="home">Home</option>
                                        <option value="followers">Followers</option>
                                        <option value="specified">Direct (Specified)</option>
                                    </select>
                                </div>
                            </div>
                        </details>

                        <!-- Text Area -->
                        <div class="mb-4 relative">
                            <textarea name="text" id="postText" rows="5"
                                class="w-full p-4 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none bg-white/80"
                                placeholder="What's happening?" required oninput="updateCharCount()"></textarea>
                            <div
                                class="absolute bottom-2 right-2 text-xs text-gray-500 bg-white/80 px-2 py-1 rounded-full border border-gray-100">
                                <span id="charCount">0</span> / <span id="charLimit">3000</span>
                            </div>
                        </div>

                        <!-- Image Upload -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Images (Max 4)</label>
                            <div class="flex items-center justify-center w-full">
                                <label for="dropzone-file"
                                    class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                        <i class="fas fa-cloud-upload-alt text-gray-400 text-3xl mb-2"></i>
                                        <p class="text-sm text-gray-500"><span class="font-semibold">Click to
                                                upload</span> or drag and drop</p>
                                        <p class="text-xs text-gray-500">PNG, JPG, GIF (MAX. 4 files)</p>
                                    </div>
                                    <input id="dropzone-file" name="images" type="file" class="hidden" multiple
                                        accept="image/*" onchange="handleFileSelect(event)" />
                                </label>
                            </div>

                            <!-- Preview Grid -->
                            <div id="previewGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4"></div>
                        </div>

                        <!-- Submit Button -->
                        <div id="mobileSubmitContainer" class="mobile-submit-container">
                            <button type="submit" id="submitBtn"
                                class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition duration-200 flex items-center justify-center">
                                <i class="fas fa-paper-plane mr-2"></i> Post Now
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Sidebar: Accounts (now second, collapsible on mobile) -->
            <div class="md:col-span-1 order-2">
                <!-- Mobile: Collapsible Account Section -->
                <div class="md:hidden mb-4">
                    <button onclick="toggleAccounts()"
                        class="w-full glass rounded-xl p-4 shadow-lg flex items-center justify-between">
                        <span class="font-bold flex items-center">
                            <i class="fas fa-users mr-2 text-blue-500"></i> Accounts
                        </span>
                        <i class="fas fa-chevron-down transition-transform" id="accountsChevron"></i>
                    </button>
                </div>

                <div id="accountsSection" class="hidden md:block space-y-6">
                    <div class="glass rounded-xl p-6 shadow-lg">
                        <h2 class="text-xl font-bold mb-4 flex items-center hidden md:flex">
                            <i class="fas fa-users mr-2 text-blue-500"></i> Accounts
                        </h2>

                        <!-- Connected Accounts List -->
                        <div class="space-y-3 mb-6">
                            {% for provider, accs in accounts.items() %}
                            {% for acc in accs %}
                            <div
                                class="flex items-center justify-between bg-white/50 p-2 rounded-lg border border-gray-200">
                                <div class="flex items-center">
                                    {% if provider == 'twitter' %}
                                    <i class="fab fa-twitter text-blue-400 mr-2"></i>
                                    {% elif provider == 'bluesky' %}
                                    <i class="fa-brands fa-bluesky text-blue-600 mr-2"></i>
                                    {% elif provider == 'misskey' %}
                                    <i class="fas fa-rocket text-green-500 mr-2"></i>
                                    {% endif %}
                                    <div class="text-sm">
                                        <div class="font-semibold">{{ acc.name }}</div>
                                        <div class="text-xs text-gray-500">@{{ acc.username }}</div>
                                    </div>
                                </div>
                                <!-- Logout/Remove could go here -->
                            </div>
                            {% endfor %}
                            {% endfor %}

                            {% if not accounts %}
                            <p class="text-sm text-gray-500 italic">No accounts connected.</p>
                            {% endif %}
                        </div>

                        <!-- Connect Buttons -->
                        <div class="space-y-2">
                            <a href="/auth/login/twitter"
                                class="block w-full py-2 px-4 bg-black text-white rounded-lg text-center hover:bg-gray-800 transition flex items-center justify-center">
                                <i class="fab fa-twitter mr-2"></i> Connect X
                            </a>
                            <a href="/auth/login/bluesky"
                                class="block w-full py-2 px-4 bg-blue-600 text-white rounded-lg text-center hover:bg-blue-700 transition flex items-center justify-center">
                                <i class="fa-brands fa-bluesky mr-2"></i> Connect Bluesky
                            </a>
                            <a href="/auth/login/misskey"
                                class="block w-full py-2 px-4 bg-green-500 text-white rounded-lg text-center hover:bg-green-600 transition flex items-center justify-center">
                                <i class="fas fa-rocket mr-2"></i> Connect Misskey
                            </a>
                        </div>

                        {% if accounts %}
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <a href="/auth/logout"
                                class="text-sm text-red-500 hover:text-red-700 flex items-center justify-center">
                                <i class="fas fa-sign-out-alt mr-1"></i> Disconnect All
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const limits = {
            'twitter': 280,
            'bluesky': 300,
            'misskey': 3000
        };

        function updateCharLimit() {
            const checkboxes = document.querySelectorAll('input[name="selected_accounts"]:checked');
            let minLimit = 3000;

            checkboxes.forEach(cb => {
                const provider = cb.value.split(':')[0];
                if (limits[provider] && limits[provider] < minLimit) {
                    minLimit = limits[provider];
                }
            });

            document.getElementById('charLimit').innerText = minLimit;
            updateCharCount();
        }

        function updateCharCount() {
            const text = document.getElementById('postText').value;
            const count = text.length;
            const limit = parseInt(document.getElementById('charLimit').innerText);

            const countEl = document.getElementById('charCount');
            countEl.innerText = count;

            if (count > limit) {
                countEl.classList.add('text-red-500', 'font-bold');
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('submitBtn').classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                countEl.classList.remove('text-red-500', 'font-bold');
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            const previewGrid = document.getElementById('previewGrid');

            if (files.length > 4) {
                alert("Maximum 4 images allowed");
                event.target.value = ""; // Clear
                previewGrid.innerHTML = "";
                return;
            }

            previewGrid.innerHTML = "";

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const div = document.createElement('div');
                    div.className = "relative aspect-square rounded-lg overflow-hidden shadow-md group";
                    div.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    `;
                    previewGrid.appendChild(div);
                }
                reader.readAsDataURL(file);
            });
        }

        // Toggle accounts section on mobile
        function toggleAccounts() {
            const section = document.getElementById('accountsSection');
            const chevron = document.getElementById('accountsChevron');
            section.classList.toggle('hidden');
            chevron.classList.toggle('rotate-180');
        }

        // ===== ここからローカル保存関連 =====
        const STORAGE_KEYS = {
            selectedAccounts: 'sns-multi-post:selected-accounts',
            misskeyVisibility: 'sns-multi-post:misskey-visibility'
        };

        function saveSelectedAccountsToStorage() {
            try {
                const checked = Array.from(
                    document.querySelectorAll('input[name="selected_accounts"]:checked')
                ).map(cb => cb.value);
                localStorage.setItem(STORAGE_KEYS.selectedAccounts, JSON.stringify(checked));
            } catch (e) {
                console.warn('Failed to save selected accounts', e);
            }
        }

        function restoreSelectedAccountsFromStorage() {
            try {
                const stored = localStorage.getItem(STORAGE_KEYS.selectedAccounts);
                if (!stored) return;

                const values = new Set(JSON.parse(stored));
                const allCbs = document.querySelectorAll('input[name="selected_accounts"]');

                allCbs.forEach(cb => {
                    cb.checked = values.has(cb.value);
                });
            } catch (e) {
                console.warn('Failed to restore selected accounts', e);
            }
        }

        function saveMisskeyVisibilityToStorage() {
            try {
                const select = document.querySelector('select[name="misskey_visibility"]');
                if (!select) return;
                localStorage.setItem(STORAGE_KEYS.misskeyVisibility, select.value);
            } catch (e) {
                console.warn('Failed to save misskey visibility', e);
            }
        }

        function restoreMisskeyVisibilityFromStorage() {
            try {
                const select = document.querySelector('select[name="misskey_visibility"]');
                if (!select) return;

                const stored = localStorage.getItem(STORAGE_KEYS.misskeyVisibility);
                if (!stored) return;

                // オプションに存在する値だけをセット
                const hasOption = Array.from(select.options).some(opt => opt.value === stored);
                if (hasOption) {
                    select.value = stored;
                }
            } catch (e) {
                console.warn('Failed to restore misskey visibility', e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            // チェックボックスと公開範囲を復元
            restoreSelectedAccountsFromStorage();
            restoreMisskeyVisibilityFromStorage();

            // 復元後に文字数上限を更新
            updateCharLimit();

            // チェックボックス変更時に保存＋上限更新
            document.querySelectorAll('input[name="selected_accounts"]').forEach(cb => {
                cb.addEventListener('change', () => {
                    saveSelectedAccountsToStorage();
                    updateCharLimit();
                });
            });

            // Misskey 公開範囲変更時に保存
            const misskeySelect = document.querySelector('select[name="misskey_visibility"]');
            if (misskeySelect) {
                misskeySelect.addEventListener('change', saveMisskeyVisibilityToStorage);
            }

            // Ctrl+Enter で送信
            document.getElementById('postText').addEventListener('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('postForm').submit();
                }
            });

            // 初期フォーカスとモバイルキーボード対応
            const textArea = document.getElementById('postText');
            if (textArea) {
                setTimeout(() => {
                    textArea.focus({ preventScroll: true });
                }, 200);
            }

            // Advanced settings（Post to / Misskey）をデスクトップではデフォルト展開
            const advanced = document.getElementById('advancedSettings');
            if (advanced && window.matchMedia) {
                const mq = window.matchMedia('(min-width: 768px)');
                if (mq.matches) {
                    advanced.open = true;
                }
                mq.addEventListener('change', (e) => {
                    if (e.matches) {
                        advanced.open = true;
                    }
                });
            }

        });
        // ===== ローカル保存関連ここまで =====
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/sw.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>

</html>